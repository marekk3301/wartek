<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Temperatura</title>
  <link rel="stylesheet" href="details_styles.css" />
  <style>
    .chart-wrap {
      position: relative;
      width: 100%;
      height: 280px;
    }
  </style>
</head>
<body>
  <header>
    <button onclick="window.history.back()">‚Üê</button>
    <span style="font-size:1.05rem; font-weight:700;">Marysia üë∂</span>
  </header>

  <main>
    <div class="temp-card">
      <div class="temp-card-value" id="currentTemp">36.8¬∞C</div>
      <div class="temp-card-label">Aktualna temperatura</div>
    </div>

    <h4>Wykres temperatury (dzisiaj)</h4>

    <div class="bar">
      <div class="chart-wrap">
        <canvas id="tempChart"></canvas>
      </div>
    </div>

  </main>
<footer style="display:flex; justify-content:center; gap:32px; padding:16px 0; background:#fff; border-radius:24px 24px 0 0; box-shadow:0 -2px 8px #e3f2fd; position:fixed; left:0; right:0; bottom:0;">
    <a href="camera.html"><img src="icons/camera_video_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt="camera" style="width:32px; height:32px; opacity:0.8;"></a>
    <a href="food.html"><img src="icons/grocery_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt="food" style="width:32px; height:32px; opacity:0.8;"></a>
    <a href="index.html"><img src="icons/person_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt="user" style="width:32px; height:32px; opacity:0.8;"></a>
    <a href="devices.html"><img src="icons/device_hub_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt="devices" style="width:32px; height:32px; opacity:0.8;"></a>
    <a href="settings.html"><img src="icons/settings_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt="settings" style="width:32px; height:32px; opacity:0.8;"></a>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <script>
    function timeToMinutes(hhmm) {
      const [h, m] = hhmm.split(':').map(Number);
      return h * 60 + m;
    }
    function minutesToTime(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    async function fetchTemperatureData() {
      const response = await fetch('data/temperature_today.csv');
      const text = await response.text();
      const lines = text.trim().split('\n');
      const xMinutes = [];
      const temps = [];

      for (let i = 1; i < lines.length; i++) {
        const [time, temp] = lines[i].split(',');
        xMinutes.push(timeToMinutes(time));
        temps.push(parseFloat(temp));
      }

      return { xMinutes, temps };
    }

    fetchTemperatureData().then(({ xMinutes, temps }) => {
      const jumpIndices = [];
      for (let i = 1; i < temps.length; i++) {
        if (Math.abs(temps[i] - temps[i - 1]) > 0.5) jumpIndices.push(i);
      }

      document.getElementById('currentTemp').textContent =
        temps[temps.length - 1].toFixed(1) + '¬∞C';

      const xMin = Math.min(...xMinutes);
      const xMax = Math.max(...xMinutes);
      const maxTemp = Math.max(...temps);
      const maxIndex = temps.indexOf(maxTemp);

      const ctx = document.getElementById('tempChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Temperatura',
            data: xMinutes.map((x, i) => ({ x, y: temps[i] })),
            borderColor: '#4aa3ff',
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 5,
            pointBackgroundColor: (ctx) =>
              jumpIndices.includes(ctx.dataIndex) ? '#e53935' : '#4aa3ff',
            fill: false,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => minutesToTime(Math.round(items[0].parsed.x)),
                label: (item) => ` ${item.parsed.y.toFixed(1)}¬∞C`
              }
            },
            annotation: {
              annotations: {
                maxLabel: {
                  type: 'label',
                  xValue: xMinutes[maxIndex],
                  yValue: maxTemp,
                  content: `${maxTemp.toFixed(1)}¬∞C`,
                  backgroundColor: 'rgba(255,255,255,0.85)',
                  borderColor: '#4aa3ff',
                  borderWidth: 1,
                  color: '#222',
                  font: { weight: 'bold', size: 12 },
                  yAdjust: -10
                }
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              min: xMin,
              max: xMax,
              grid: { color: '#eef2f5' },
              ticks: {
                stepSize: 120, // co 2h
                callback: (value) => {
                  const h = Math.floor(value / 60);
                  const m = value % 60;
                  return m === 0 && h % 2 === 0 ? `${String(h).padStart(2, '0')}:00` : '';
                },
                maxRotation: 0,
                autoSkip: false
              }
            },
            y: {
              min: 35.5,
              max: 40,
              ticks: { stepSize: 0.5 },
              grid: { color: '#eef2f5' }
            }
          },
          elements: { point: { hitRadius: 10 } }
        },
        plugins: [Chart.registry.getPlugin('annotation')]
      });
    });
  </script>
</body>
</html>
