<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sen</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="details_styles.css"/>
  <style>
    .label {
      font-size:.9em;
      color:#555;
      margin-bottom:6px;
    }

    .chart-wrap {
      position:relative;
      width:100%;
      height:100px;
    }
  </style>
</head>
<body>
  <header>
    <button onclick="window.history.back()">‚Üê</button>
    <span style="font-size:1.05rem; font-weight:700;">Marysia üë∂</span>
  </header>

  <main>
    <h2>Sen</h2>

    <div class="card">
      <div class="label">Hipnogram 24 h (ko≈Ñczy siƒô bie≈ºƒÖcƒÖ godzinƒÖ)</div>
      <div class="chart-wrap">
        <canvas id="hypno"></canvas>
      </div>
      <div style="margin-top:6px;">
        <span class="badge">o≈õ X: co 4 h</span>
        <span class="badge">REM / Light / Deep / Wake</span>
      </div>
    </div>

    <div class="card">
      <div class="label">Rozk≈Çad faz (24 h)</div>
      <div class="chart-wrap" style="height:100px;">
        <canvas id="dist"></canvas>
      </div>

      <div class="label" style="margin-top:10px;">Ruch (ostatnie 60 min)</div>
      <div class="chart-wrap" style="height:90px;">
        <canvas id="movementSpark"></canvas>
      </div>
    </div>

    <p style="text-align:center; font-size:.85em; color:#777;">Dane poglƒÖdowe, nie medyczne.</p>
  </main>

  <footer>
    <a href="camera.html"><img src="icons/camera_video_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt=""></a>
    <a href="food.html"><img src="icons/grocery_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt=""></a>
    <a href="index.html"><img src="icons/person_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt=""></a>
    <a href="devices.html"><img src="icons/device_hub_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt=""></a>
    <a href="settings.html"><img src="icons/settings_24dp_1F1F1F_FILL0_wght400_GRAD0_opsz24.svg" alt=""></a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function loadSleepCSV(){
      const r = await fetch('data/sleep_today.csv');
      if(!r.ok){ console.error('sleep CSV fetch error', r.status); return []; }
      const txt = await r.text();
      const lines = txt.trim().split(/\r?\n/);
      const out=[];
      for(let i=1;i<lines.length;i++){
        const [time,stage,move,hr,rr]=lines[i].split(',');
        out.push({
          time:(time||'').trim(),
          stage:(stage||'').trim(),
          movement:parseFloat(move)||0,
          hr:parseInt(hr)||0,
          rr:parseInt(rr)||0
        });
      }
      return out;
    }

    const stageOrder=['Wake','REM','Light','Deep'];
    const stageToY=s=>stageOrder.indexOf(s);
    const yToLabel=i=>stageOrder[i]||'';
    const timeToMin=t=>{const [h,m]=t.split(':').map(Number);return h*60+m;};
    const pad2=n=>String(n).padStart(2,'0');
    const minToTime=m=>`${pad2(Math.floor(m/60))}:${pad2(m%60)}`;

    function minutesInStage(data,stage){return data.filter(d=>d.stage===stage).length*5;}

    function makeSpark(ctx,xs,ys){
      new Chart(ctx,{
        type:'line',
        data:{labels:xs,datasets:[{data:ys,borderColor:'#64b5f6',borderWidth:2,pointRadius:0,fill:false,tension:0.3}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}
      });
    }

    function makeHypnogram(ctx,points){
      const now=new Date();
      const endMin=now.getHours()*60;
      const startMin=endMin-1440;
      return new Chart(ctx,{
        type:'line',
        data:{datasets:[{data:points,borderColor:'#64b5f6',borderWidth:2,pointRadius:0,fill:false,stepped:true}]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false}},
          scales:{
            x:{type:'linear',min:startMin,max:endMin,
              grid:{color:'#eaf2fd'},
              ticks:{
                stepSize:120,
                autoSkip:false,
                callback:(v)=>{
                  const h=Math.floor((v%1440)/60);
                  const m=Math.floor(v%60);
                  if(m!==0) return '';
                  if(h===0) return '';
                  return (h%4===0)?String(h):'';
                }
              }
            },
            y:{type:'linear',min:-0.5,max:3.5,
              ticks:{stepSize:1,callback:yToLabel},
              grid:{color:'#eaf2fd'}
            }
          }
        },
        plugins:[{
          id:'nowLine',
          afterDatasetsDraw(chart){
            const {ctx,chartArea,scales:{x}}=chart;
            const nowX=x.getPixelForValue(endMin);
            ctx.save();ctx.strokeStyle='#e53935';ctx.lineWidth=2;
            ctx.beginPath();ctx.moveTo(nowX,chartArea.top);ctx.lineTo(nowX,chartArea.bottom);ctx.stroke();
            ctx.restore();
          }
        }]
      });
    }

    function makeDistribution(ctx,pct){
      new Chart(ctx,{
        type:'bar',
        data:{labels:Object.keys(pct),datasets:[{data:Object.values(pct),backgroundColor:['#b0bec5','#42a5f5','#90caf9','#64b5f6'],borderWidth:0}]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},tooltip:{callbacks:{label:(it)=>`${it.parsed.y}%`}}},
          scales:{
            x:{grid:{display:false}},
            y:{min:0,max:100,ticks:{stepSize:20,callback:v=>v+'%'},grid:{color:'#eaf2fd'}}
          }
        }
      });
    }

    (async()=>{
      const data=await loadSleepCSV();
      if(!data.length) return;
      data.sort((a,b)=>timeToMin(a.time)-timeToMin(b.time));

      const now=new Date();
      const endMin=now.getHours()*60;
      const pts=data.map(d=>{
        const m=timeToMin(d.time);
        const x=(m<=endMin)?m:m-1440;
        return {x,y:stageToY(d.stage)};
      }).sort((a,b)=>a.x-b.x);
      makeHypnogram(document.getElementById('hypno').getContext('2d'),pts);

      const totalMin=data.length*5;
      const pct={
        Wake:Math.round(100*minutesInStage(data,'Wake')/totalMin),
        REM:Math.round(100*minutesInStage(data,'REM')/totalMin),
        Light:Math.round(100*minutesInStage(data,'Light')/totalMin),
        Deep:Math.round(100*minutesInStage(data,'Deep')/totalMin)
      };
      makeDistribution(document.getElementById('dist').getContext('2d'),pct);

      const lastMin=timeToMin(data[data.length-1].time);
      const startWin=(lastMin-60+1440)%1440;
      const movWin=data.filter(p=>{
        const m=timeToMin(p.time);
        return startWin<=lastMin?(m>=startWin&&m<=lastMin):(m>=startWin||m<=lastMin);
      });
      makeSpark(document.getElementById('movementSpark').getContext('2d'),
                movWin.map(d=>d.time),
                movWin.map(d=>d.movement));
    })();
  </script>
</body>
</html>
